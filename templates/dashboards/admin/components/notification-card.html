<!-- Notification Card Component -->
<div class="notification-card mb-3" data-notification-id="{{ notification.id }}">
    <div class="card border-0 shadow-sm">
        <div class="card-body p-3">
            <div class="d-flex align-items-start">
                <!-- Notification Icon -->
                <div class="notification-icon me-3 flex-shrink-0">
                    <div class="icon-wrapper rounded-circle d-flex align-items-center justify-content-center">
                        <i class="fas {{ notification.icon|default:'fa-bell' }} fa-lg"></i>
                    </div>
                </div>
                
                <!-- Notification Content -->
                <div class="notification-content flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="notification-title mb-0 fw-semibold">
                            {{ notification.title|default:'Notification' }}
                        </h6>
                        <small class="text-muted notification-time">
                            {{ notification.created_at|timesince }} ago
                        </small>
                    </div>
                    
                    <p class="notification-message mb-2 text-muted">
                        {{ notification.message|truncatewords:20 }}
                    </p>
                    
                    <!-- Notification Meta -->
                    <div class="notification-meta d-flex align-items-center">
                        <span class="badge notification-type me-2">
                            {{ notification.type|title }}
                        </span>
                        
                        {% if notification.priority %}
                        <span class="badge badge-priority me-2">
                            <i class="fas fa-flag fa-xs me-1"></i>
                            {{ notification.priority|title }}
                        </span>
                        {% endif %}
                        
                        {% if notification.read_at %}
                        <small class="text-success">
                            <i class="fas fa-check-circle me-1"></i>
                            Read
                        </small>
                        {% else %}
                        <small class="text-primary">
                            <i class="fas fa-circle fa-xs me-1"></i>
                            Unread
                        </small>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Notification Actions -->
                <div class="notification-actions ms-3 flex-shrink-0">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if not notification.read_at %}
                            <li>
                                <a class="dropdown-item" href="#" onclick="markAsRead('{{ notification.id }}')">
                                    <i class="fas fa-check me-2"></i>
                                    Mark as Read
                                </a>
                            </li>
                            {% endif %}
                            
                            <li>
                                <a class="dropdown-item" href="#" onclick="viewDetails('{{ notification.id }}')">
                                    <i class="fas fa-eye me-2"></i>
                                    View Details
                                </a>
                            </li>
                            
                            {% if notification.action_url %}
                            <li>
                                <a class="dropdown-item" href="{{ notification.action_url }}">
                                    <i class="fas fa-external-link-alt me-2"></i>
                                    Take Action
                                </a>
                            </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="deleteNotification('{{ notification.id }}')">
                                    <i class="fas fa-trash me-2"></i>
                                    Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Toast (for real-time notifications) -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <div class="toast-icon me-2">
                <i class="fas fa-bell text-primary"></i>
            </div>
            <strong class="me-auto toast-title">Notification</strong>
            <small class="toast-time">now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <span class="toast-message">New notification received</span>
        </div>
    </div>
</div>

<style>
.notification-card {
    transition: all 0.3s ease;
}

.notification-card:hover {
    transform: translateY(-2px);
}

.notification-card .card {
    border-radius: 10px;
    border-left: 4px solid var(--bs-primary);
}

.notification-card[data-type="success"] .card {
    border-left-color: var(--bs-success);
}

.notification-card[data-type="warning"] .card {
    border-left-color: var(--bs-warning);
}

.notification-card[data-type="error"] .card {
    border-left-color: var(--bs-danger);
}

.notification-card[data-type="info"] .card {
    border-left-color: var(--bs-info);
}

.notification-icon .icon-wrapper {
    width: 40px;
    height: 40px;
    background: rgba(var(--bs-primary-rgb), 0.1);
    color: var(--bs-primary);
}

.notification-card[data-type="success"] .icon-wrapper {
    background: rgba(var(--bs-success-rgb), 0.1);
    color: var(--bs-success);
}

.notification-card[data-type="warning"] .icon-wrapper {
    background: rgba(var(--bs-warning-rgb), 0.1);
    color: var(--bs-warning);
}

.notification-card[data-type="error"] .icon-wrapper {
    background: rgba(var(--bs-danger-rgb), 0.1);
    color: var(--bs-danger);
}

.notification-card[data-type="info"] .icon-wrapper {
    background: rgba(var(--bs-info-rgb), 0.1);
    color: var(--bs-info);
}

.notification-type {
    background: rgba(var(--bs-primary-rgb), 0.1);
    color: var(--bs-primary);
    border: 1px solid rgba(var(--bs-primary-rgb), 0.2);
}

.badge-priority {
    background: rgba(var(--bs-warning-rgb), 0.1);
    color: var(--bs-warning);
    border: 1px solid rgba(var(--bs-warning-rgb), 0.2);
}

.badge-priority.high {
    background: rgba(var(--bs-danger-rgb), 0.1);
    color: var(--bs-danger);
    border: 1px solid rgba(var(--bs-danger-rgb), 0.2);
}

.notification-card.unread {
    background: rgba(var(--bs-primary-rgb), 0.02);
}

.notification-card.unread .card {
    box-shadow: 0 2px 15px rgba(var(--bs-primary-rgb), 0.15);
}

/* Toast Styles */
.toast {
    border-radius: 10px;
    border: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.toast-header {
    background: rgba(var(--bs-primary-rgb), 0.05);
    border-bottom: 1px solid rgba(var(--bs-primary-rgb), 0.1);
}

.toast-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply notification type classes
    document.querySelectorAll('.notification-card').forEach(card => {
        const type = card.querySelector('.notification-type')?.textContent?.toLowerCase();
        if (type) {
            card.setAttribute('data-type', type);
        }
        
        // Check if unread
        const isUnread = card.querySelector('.text-primary:contains("Unread")');
        if (isUnread) {
            card.classList.add('unread');
        }
    });
});

// Mark notification as read
function markAsRead(notificationId) {
    fetch(`/admin/notifications/${notificationId}/mark-read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const card = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (card) {
                card.classList.remove('unread');
                const readStatus = card.querySelector('.notification-meta small:last-child');
                if (readStatus) {
                    readStatus.innerHTML = '<i class="fas fa-check-circle me-1"></i>Read';
                    readStatus.className = 'text-success';
                }
            }
            showToast('Notification marked as read', 'success');
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
        showToast('Error marking notification as read', 'error');
    });
}

// View notification details
function viewDetails(notificationId) {
    fetch(`/admin/notifications/${notificationId}`)
    .then(response => response.json())
    .then(data => {
        // Show notification details in modal or navigate to details page
        showNotificationModal(data);
    })
    .catch(error => {
        console.error('Error fetching notification details:', error);
        showToast('Error loading notification details', 'error');
    });
}

// Delete notification
function deleteNotification(notificationId) {
    showConfirmModal({
        title: 'Delete Notification',
        message: 'Are you sure you want to delete this notification?',
        confirmText: 'Delete',
        confirmClass: 'btn-danger',
        callback: () => {
            fetch(`/admin/notifications/${notificationId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const card = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (card) {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(100%)';
                        setTimeout(() => card.remove(), 300);
                    }
                    showToast('Notification deleted', 'success');
                }
            })
            .catch(error => {
                console.error('Error deleting notification:', error);
                showToast('Error deleting notification', 'error');
            });
        }
    });
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.getElementById('liveToast');
    const toastIcon = toast.querySelector('.toast-icon i');
    const toastTitle = toast.querySelector('.toast-title');
    const toastMessage = toast.querySelector('.toast-message');
    const toastTime = toast.querySelector('.toast-time');
    
    // Set icon and color based on type
    const iconMap = {
        'success': 'fa-check-circle text-success',
        'error': 'fa-exclamation-circle text-danger',
        'warning': 'fa-exclamation-triangle text-warning',
        'info': 'fa-info-circle text-info'
    };
    
    toastIcon.className = `fas ${iconMap[type] || iconMap.info}`;
    toastTitle.textContent = type.charAt(0).toUpperCase() + type.slice(1);
    toastMessage.textContent = message;
    toastTime.textContent = 'now';
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Show notification details modal
function showNotificationModal(notification) {
    // This would be implemented based on your modal system
    console.log('Show notification details:', notification);
}

// Helper function to get CSRF token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Real-time notification handling (WebSocket example)
if (typeof io !== 'undefined') {
    const socket = io('/admin-notifications');
    
    socket.on('new_notification', function(notification) {
        showToast(notification.message, notification.type);
        
        // Add new notification to the list if on notifications page
        if (window.location.pathname.includes('/notifications')) {
            prependNotification(notification);
        }
        
        // Update notification count
        updateNotificationCount();
    });
}

// Prepend new notification to list
function prependNotification(notification) {
    const container = document.querySelector('.notifications-container');
    if (container) {
        const notificationHtml = renderNotificationCard(notification);
        container.insertAdjacentHTML('afterbegin', notificationHtml);
    }
}

// Update notification count in header
function updateNotificationCount() {
    fetch('/admin/notifications/count')
    .then(response => response.json())
    .then(data => {
        const badge = document.querySelector('.notification-count-badge');
        if (badge) {
            badge.textContent = data.unread_count;
            badge.style.display = data.unread_count > 0 ? 'inline' : 'none';
        }
    });
}
</script>
