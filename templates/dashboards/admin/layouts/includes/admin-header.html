<!-- Admin Header -->
<header class="admin-header">
    <div class="container-fluid px-3 h-100">
        <div class="row align-items-center h-100">
            <!-- Left Side -->
            <div class="col-6 col-md-4">
                <div class="d-flex align-items-center">
                    <!-- Sidebar Toggle -->
                    <button class="btn btn-link text-dark p-2 me-3" id="sidebarToggle" type="button">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- Search Bar -->
                    <div class="header-search d-none d-md-block">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0 bg-light" 
                                   placeholder="Search users, orders, products..." 
                                   data-search
                                   id="globalSearch">
                            <div class="search-results position-absolute bg-white border rounded shadow-lg mt-1 d-none" 
                                 id="searchResults" style="top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto;">
                                <!-- Search results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Side -->
            <div class="col-6 col-md-8">
                <div class="d-flex align-items-center justify-content-end">
                    <!-- Quick Actions -->
                    <div class="quick-actions d-none d-lg-flex me-3">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="AdminApp.navigateTo('/admin/users/create/')" title="Add User">
                            <i class="fas fa-user-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success me-2" onclick="AdminApp.navigateTo('/admin/products/create/')" title="Add Product">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="refreshDashboard()" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <!-- Notifications -->
                    <div class="dropdown me-3">
                        <button class="btn btn-link text-dark position-relative p-2" type="button" 
                                id="notificationsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell fa-lg"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-count-badge" 
                                  id="notificationBadge" style="font-size: 0.6rem;">
                                {{ unread_notifications_count|default:0 }}
                            </span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationsDropdown">
                            <div class="dropdown-header d-flex justify-content-between align-items-center">
                                <span class="fw-semibold">Notifications</span>
                                <button class="btn btn-sm btn-link text-primary p-0" onclick="markAllAsRead()">
                                    Mark all as read
                                </button>
                            </div>
                            <div class="dropdown-divider"></div>
                            
                            <div class="notification-list" id="notificationList" style="max-height: 300px; overflow-y: auto;">
                                {% for notification in recent_notifications|slice:":5" %}
                                <div class="dropdown-item notification-item {% if not notification.read_at %}unread{% endif %}" 
                                     data-notification-id="{{ notification.id }}">
                                    <div class="d-flex">
                                        <div class="notification-icon me-3">
                                            <i class="fas {{ notification.icon|default:'fa-info-circle' }} text-{{ notification.type|default:'primary' }}"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="notification-title fw-medium">{{ notification.title }}</div>
                                            <div class="notification-text text-muted small">{{ notification.message|truncatewords:10 }}</div>
                                            <div class="notification-time text-muted small">{{ notification.created_at|timesince }} ago</div>
                                        </div>
                                        {% if not notification.read_at %}
                                        <div class="notification-unread-dot bg-primary"></div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="dropdown-item-text text-center text-muted">
                                    <i class="fas fa-bell-slash fa-2x mb-2"></i>
                                    <div>No notifications</div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item text-center">
                                <a href="{% url 'platform_admin:settings-notifications' %}" class="btn btn-sm btn-primary">
                                    View All Notifications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button class="btn btn-link text-dark me-3 p-2" onclick="toggleTheme()" title="Toggle Theme">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="dropdown">
                        <button class="btn btn-link text-dark d-flex align-items-center p-2" type="button" 
                                id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar me-2">
                                {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" alt="{{ user.get_full_name }}" class="rounded-circle" width="32" height="32">
                                {% else %}
                                <div class="avatar-placeholder rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                     style="width: 32px; height: 32px; font-size: 0.875rem;">
                                    {{ user.get_full_name|first|upper|default:'A' }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="user-info d-none d-md-block text-start">
                                <div class="user-name fw-medium">{{ user.get_full_name|default:user.username }}</div>
                                <div class="user-role text-muted small">{{ user.role|title|default:'Administrator' }}</div>
                            </div>
                            <i class="fas fa-chevron-down ms-2"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end user-dropdown">
                            <li class="dropdown-header">
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-2">
                                        {% if user.avatar %}
                                        <img src="{{ user.avatar.url }}" alt="{{ user.get_full_name }}" class="rounded-circle" width="40" height="40">
                                        {% else %}
                                        <div class="avatar-placeholder rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            {{ user.get_full_name|first|upper|default:'A' }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ user.get_full_name|default:user.username }}</div>
                                        <div class="text-muted small">{{ user.email }}</div>
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            
                            <li>
                                <a class="dropdown-item" href="{% url 'platform_admin:settings-general' %}">
                                    <i class="fas fa-user me-2 text-primary"></i>
                                    My Profile
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'platform_admin:settings-general' %}">
                                    <i class="fas fa-cog me-2 text-secondary"></i>
                                    Account Settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'platform_admin:system-logs' %}">
                                    <i class="fas fa-history me-2 text-info"></i>
                                    Activity Log
                                </a>
                            </li>
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <li>
                                <a class="dropdown-item" href="{% url 'help' %}">
                                    <i class="fas fa-question-circle me-2 text-warning"></i>
                                    Help & Support
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'platform_admin:system-status' %}">
                                    <i class="fas fa-server me-2 text-success"></i>
                                    System Status
                                </a>
                            </li>
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="confirmLogout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    Sign Out
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<style>
.admin-header .container-fluid {
    height: 100%;
}

.header-search {
    width: 300px;
    position: relative;
}

.header-search .input-group-text {
    border: 1px solid #d1d5db;
    border-right: none;
}

.header-search .form-control {
    border: 1px solid #d1d5db;
    border-left: none;
}

.header-search .form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(10, 36, 99, 0.25);
    border-color: var(--primary-color);
}

.quick-actions .btn {
    border-radius: 6px;
    border-width: 1px;
    font-size: 0.875rem;
}

.notification-dropdown {
    width: 350px;
    border-radius: 10px;
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.notification-item {
    padding: 0.75rem 1rem;
    border: none;
    border-bottom: 1px solid #f3f4f6;
}

.notification-item:hover {
    background-color: #f9fafb;
}

.notification-item.unread {
    background-color: rgba(59, 130, 246, 0.05);
    border-left: 3px solid #3b82f6;
}

.notification-icon {
    width: 24px;
    text-align: center;
}

.notification-unread-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 0.25rem;
}

.user-dropdown {
    width: 280px;
    border-radius: 10px;
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.user-dropdown .dropdown-header {
    padding: 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.user-dropdown .dropdown-item {
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
}

.user-dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}

.avatar-placeholder {
    font-weight: 600;
}

.notification-count-badge {
    display: {{ unread_notifications_count|yesno:"inline,none" }};
}

/* Search Results */
.search-results .search-result-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.search-results .search-result-item:hover {
    background-color: #f9fafb;
}

.search-results .search-result-item:last-child {
    border-bottom: none;
}

.search-result-title {
    font-weight: 500;
    color: #1f2937;
}

.search-result-meta {
    font-size: 0.875rem;
    color: #6b7280;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .user-info {
        display: none !important;
    }
    
    .quick-actions {
        display: none !important;
    }
    
    .notification-dropdown,
    .user-dropdown {
        width: 280px;
    }
}

/* Theme Toggle Animation */
#themeIcon {
    transition: transform 0.3s ease;
}

.btn:hover #themeIcon {
    transform: rotate(180deg);
}

/* Real-time Updates Indicator */
.live-indicator {
    position: relative;
}

.live-indicator::after {
    content: '';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 6px;
    height: 6px;
    background: #10b981;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeHeader();
});

function initializeHeader() {
    initializeSearch();
    initializeNotifications();
    initializeTheme();
}

// Global Search Functionality
function initializeSearch() {
    const searchInput = document.getElementById('globalSearch');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.classList.add('d-none');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('d-none');
            }
        });
    }
}

function performSearch(query) {
    const searchResults = document.getElementById('searchResults');
    
    fetch(`/admin/api/search?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
        displaySearchResults(data.results);
    })
    .catch(error => {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div class="p-3 text-muted text-center">Search temporarily unavailable</div>';
        searchResults.classList.remove('d-none');
    });
}

function displaySearchResults(results) {
    const searchResults = document.getElementById('searchResults');
    
    if (!results || results.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-muted text-center">No results found</div>';
    } else {
        const resultHtml = results.map(result => `
            <div class="search-result-item" onclick="AdminApp.navigateTo('${result.url}')">
                <div class="search-result-title">${result.title}</div>
                <div class="search-result-meta">${result.type} â€¢ ${result.meta}</div>
            </div>
        `).join('');
        
        searchResults.innerHTML = resultHtml;
    }
    
    searchResults.classList.remove('d-none');
}

// Notifications
function initializeNotifications() {
    // Mark notification as read when clicked
    document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', function() {
            const notificationId = this.getAttribute('data-notification-id');
            if (notificationId && this.classList.contains('unread')) {
                markNotificationAsRead(notificationId);
            }
        });
    });
    
    // Real-time notifications via WebSocket
    if (typeof io !== 'undefined') {
        const socket = io('/admin-notifications');
        
        socket.on('new_notification', function(notification) {
            addNewNotification(notification);
            updateNotificationBadge();
        });
    }
}

function markNotificationAsRead(notificationId) {
    fetch(`/admin/api/notifications/${notificationId}/mark-read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationItem) {
                notificationItem.classList.remove('unread');
                const dot = notificationItem.querySelector('.notification-unread-dot');
                if (dot) dot.remove();
            }
            updateNotificationBadge(-1);
        }
    })
    .catch(error => console.error('Error marking notification as read:', error));
}

function markAllAsRead() {
    fetch('/admin/api/notifications/mark-all-read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.classList.remove('unread');
                const dot = item.querySelector('.notification-unread-dot');
                if (dot) dot.remove();
            });
            updateNotificationBadge(0, true);
        }
    })
    .catch(error => console.error('Error marking all notifications as read:', error));
}

function addNewNotification(notification) {
    const notificationList = document.getElementById('notificationList');
    const emptyState = notificationList.querySelector('.dropdown-item-text');
    
    if (emptyState) {
        emptyState.remove();
    }
    
    const notificationHtml = `
        <div class="dropdown-item notification-item unread" data-notification-id="${notification.id}">
            <div class="d-flex">
                <div class="notification-icon me-3">
                    <i class="fas ${notification.icon || 'fa-info-circle'} text-${notification.type || 'primary'}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="notification-title fw-medium">${notification.title}</div>
                    <div class="notification-text text-muted small">${notification.message}</div>
                    <div class="notification-time text-muted small">now</div>
                </div>
                <div class="notification-unread-dot bg-primary"></div>
            </div>
        </div>
    `;
    
    notificationList.insertAdjacentHTML('afterbegin', notificationHtml);
    
    // Remove oldest notification if there are more than 5
    const notifications = notificationList.querySelectorAll('.notification-item');
    if (notifications.length > 5) {
        notifications[notifications.length - 1].remove();
    }
}

function updateNotificationBadge(change = null, reset = false) {
    const badge = document.getElementById('notificationBadge');
    
    if (reset) {
        badge.textContent = '0';
        badge.style.display = 'none';
    } else if (change !== null) {
        let currentCount = parseInt(badge.textContent) || 0;
        currentCount = Math.max(0, currentCount + change);
        badge.textContent = currentCount;
        badge.style.display = currentCount > 0 ? 'inline' : 'none';
    } else {
        // Fetch current count
        fetch('/admin/api/notifications/count')
        .then(response => response.json())
        .then(data => {
            badge.textContent = data.unread_count;
            badge.style.display = data.unread_count > 0 ? 'inline' : 'none';
        });
    }
}

// Theme Management
function initializeTheme() {
    const themeIcon = document.getElementById('themeIcon');
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    
    updateThemeIcon(currentTheme);
}

function updateThemeIcon(theme) {
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }
}

// Override the toggleTheme function to update icon
const originalToggleTheme = window.toggleTheme;
window.toggleTheme = function() {
    if (originalToggleTheme) originalToggleTheme();
    
    const newTheme = document.documentElement.getAttribute('data-theme');
    updateThemeIcon(newTheme);
};

// Logout Confirmation
function confirmLogout() {
    if (confirm('Are you sure you want to sign out?')) {
        AdminApp.showLoading();
        window.location.href = '{% url "logout" %}';
    }
}

// Refresh Dashboard
function refreshDashboard() {
    if (window.location.pathname.includes('/dashboard')) {
        window.location.reload();
    } else {
        AdminApp.navigateTo('{% url "platform_admin:dashboard" %}');
    }
}

// Keyboard Shortcuts for Header
document.addEventListener('keydown', function(e) {
    // Alt + N for notifications
    if (e.altKey && e.key === 'n') {
        e.preventDefault();
        document.getElementById('notificationsDropdown').click();
    }
    
    // Alt + U for user menu
    if (e.altKey && e.key === 'u') {
        e.preventDefault();
        document.getElementById('userMenuDropdown').click();
    }
    
    // Alt + T for theme toggle
    if (e.altKey && e.key === 't') {
        e.preventDefault();
        toggleTheme();
    }
});
</script>
