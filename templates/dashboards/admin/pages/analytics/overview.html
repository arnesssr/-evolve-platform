{% extends 'dashboards/admin/layouts/admin-base.html' %}
{% load static %}

{% block title %}Analytics Overview{% endblock %}

{% block page_title %}Analytics Overview{% endblock %}
{% block page_subtitle %}Comprehensive platform analytics and insights{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'platform_admin:dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item active">Analytics</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <!-- Keep action buttons; move date-range to compact filter bar below -->
    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#customAnalyticsModal">
        <i class="fas fa-cog me-2"></i>Custom Analytics
    </button>
    {% include 'dashboards/admin/components/export-button.html' with export_type="analytics" %}
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
        <i class="fas fa-chart-line me-2"></i>Generate Report
    </button>
</div>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Compact vertical rhythm for the analytics page */
  .analytics-page .content-card { padding: 1rem; margin-bottom: 0.75rem; }
  .analytics-page .row.mb-4 { margin-bottom: 0.75rem !important; }
  .analytics-page .row.mb-3 { margin-bottom: 0.5rem !important; }
  .analytics-page .content-card h5 { margin-bottom: 0.75rem !important; }
  .analytics-page .table { margin-bottom: 0; }
  .analytics-page .chart-container { height: auto; }
</style>
{% endblock %}

{% block content %}
<div class="analytics-page">
{% include 'dashboards/admin/components/filter-bar.html' with show_search=False offcanvas_id=None show_date_range=True %}


<!-- Revenue & Growth Charts -->
<div class="row mb-3">
    <!-- Revenue Trends -->
    <div class="col-lg-8">
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">Revenue & Growth Trends</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-period="12months">12M</button>
                    <button type="button" class="btn btn-outline-primary" data-period="6months">6M</button>
                    <button type="button" class="btn btn-outline-primary" data-period="3months">3M</button>
                    <button type="button" class="btn btn-outline-primary" data-period="1month">1M</button>
                </div>
            </div>
            <div class="chart-container" style="height: 320px;">
                <canvas id="revenueGrowthChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Business Growth -->
    <div class="col-lg-4">
        <div class="content-card">
            <h5 class="mb-4">Business Acquisition</h5>
            <canvas id="businessGrowthChart" height="200"></canvas>
            
        </div>
    </div>
</div>


<!-- Modals -->
{% include 'dashboards/admin/modals/generate-report.html' with report_type="analytics" %}
{% include 'dashboards/admin/modals/date-range.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize charts only
    initializeAnalyticsCharts();
});

function initializeAnalyticsCharts() {
    // Revenue & Growth Chart
    const revenueCtx = document.getElementById('revenueGrowthChart').getContext('2d');
    window.revenueGrowthChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Revenue',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Growth Rate',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
title: { display: true, text: `Revenue (${window.PlatformSettings?.currency_symbol || '$'})` }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Growth Rate (%)' },
                    grid: { drawOnChartArea: false },
                }
            }
        }
    });

    // Business Growth Chart
    const bizCtx = document.getElementById('businessGrowthChart')?.getContext('2d');
    if (bizCtx) {
        window.businessGrowthChart = new Chart(bizCtx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'New Businesses', data: [], backgroundColor: 'rgba(59, 130, 246, 0.6)'}] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // Plan Distribution Chart (optional)
    const planEl = document.getElementById('planDistributionChart');
    if (planEl) {
        window.planDistributionChart = new Chart(planEl.getContext('2d'), {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: ['#10b981', '#3b82f6', '#06b6d4'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
    
    // User Activity Chart (optional)
    const activityEl = document.getElementById('userActivityChart');
    if (activityEl) {
        window.userActivityChart = new Chart(activityEl.getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Active Users', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    // Load data
    loadAnalyticsData();
}

async function loadAnalyticsData() {
    try {
        // Growth trends over last 30 days
        const gtRes = await fetch('/platform/admin/api/v1/dashboard/growth-trends/?days=30', { credentials: 'same-origin' });
        if (gtRes.ok) {
            const gt = await gtRes.json();
            const labels = (gt.revenue_growth || []).map(p => p.date);
            if (window.revenueGrowthChart) {
                window.revenueGrowthChart.data.labels = labels;
                window.revenueGrowthChart.data.datasets[0].data = (gt.revenue_growth || []).map(p => p.count);
                // Growth rate derived as percent change from previous day (simple)
                const gr = []; const rev = window.revenueGrowthChart.data.datasets[0].data;
                for (let i = 0; i < rev.length; i++) {
                    if (i === 0 || rev[i-1] === 0) { gr.push(0); } else { gr.push(((rev[i]-rev[i-1]) / Math.max(1, rev[i-1])) * 100); }
                }
                window.revenueGrowthChart.data.datasets[1].data = gr;
                window.revenueGrowthChart.update();
            }
            if (window.businessGrowthChart) {
                window.businessGrowthChart.data.labels = (gt.business_growth || []).map(p => p.date);
                window.businessGrowthChart.data.datasets[0].data = (gt.business_growth || []).map(p => p.count);
                window.businessGrowthChart.update();
            }
            if (window.userActivityChart) {
                window.userActivityChart.data.labels = (gt.user_growth || []).map(p => p.date);
                window.userActivityChart.data.datasets[0].data = (gt.user_growth || []).map(p => p.count);
                window.userActivityChart.update();
            }
        }

        // Dashboard metrics (to possibly update any KPI cards in future)
        const dmRes = await fetch('/platform/admin/api/v1/dashboard/metrics/?period=last_30_days', { credentials: 'same-origin' });
        if (dmRes.ok) {
            const dm = await dmRes.json();
            // Hook: if we later add KPIs on this page, we can populate them here.
        }
    } catch (e) {
        console.warn('Failed to load analytics data', e);
    }
}
</script>
{% endblock %}
