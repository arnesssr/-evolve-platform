{% extends 'dashboards/admin/layouts/admin-base.html' %}
{% load static %}

{% block title %}Analytics Overview{% endblock %}

{% block page_title %}Analytics Overview{% endblock %}
{% block page_subtitle %}Comprehensive platform analytics and insights{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'platform_admin:dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item active">Analytics</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <!-- Keep action buttons; move date-range to compact filter bar below -->
    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#customAnalyticsModal">
        <i class="fas fa-cog me-2"></i>Custom Analytics
    </button>
    {% include 'dashboards/admin/components/export-button.html' with export_type="analytics" %}
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
        <i class="fas fa-chart-line me-2"></i>Generate Report
    </button>
</div>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Compact vertical rhythm for the analytics page */
  .analytics-page .content-card { padding: 1rem; margin-bottom: 0.75rem; }
  .analytics-page .row.mb-4 { margin-bottom: 0.75rem !important; }
  .analytics-page .row.mb-3 { margin-bottom: 0.5rem !important; }
  .analytics-page .content-card h5 { margin-bottom: 0.75rem !important; }
  .analytics-page .table { margin-bottom: 0; }
  .analytics-page .chart-container { height: auto; }
</style>
{% endblock %}

{% block content %}
<div class="analytics-page">
{% include 'dashboards/admin/components/filter-bar.html' with show_search=False offcanvas_id=None show_date_range=True %}

<!-- Key Performance Indicators -->
<div class="content-card">
  <small class="text-muted">No KPI data available.</small>
</div>

<!-- Revenue & Growth Charts -->
<div class="row mb-3">
    <!-- Revenue Trends -->
    <div class="col-lg-8">
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">Revenue & Growth Trends</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-period="12months">12M</button>
                    <button type="button" class="btn btn-outline-primary" data-period="6months">6M</button>
                    <button type="button" class="btn btn-outline-primary" data-period="3months">3M</button>
                    <button type="button" class="btn btn-outline-primary" data-period="1month">1M</button>
                </div>
            </div>
            <div class="chart-container" style="height: 320px;">
                <canvas id="revenueGrowthChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Business Growth -->
    <div class="col-lg-4">
        <div class="content-card">
            <h5 class="mb-4">Business Acquisition</h5>
            <canvas id="businessGrowthChart" height="200"></canvas>
            
        </div>
    </div>
</div>

<!-- Show more analytics toggle -->
<div class="d-flex justify-content-center my-2">
  <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#analyticsMore" aria-expanded="false" aria-controls="analyticsMore" id="analyticsMoreToggle">
    Show more analytics
  </button>
</div>

<!-- Collapsible extra analytics -->
<div id="analyticsMore" class="collapse">

<!-- Business & Plan Analytics -->
<div class="row mb-4">
    <!-- Plan Distribution -->
    <div class="col-lg-6">
        <div class="content-card">
            <h5 class="mb-4">Plan Distribution</h5>
            <canvas id="planDistributionChart" height="200"></canvas>
            
        </div>
    </div>
    
    <!-- Industry Breakdown -->
    <div class="col-lg-6">
        <div class="content-card">
            <h5 class="mb-4">Industry Breakdown</h5>
            <p class="text-muted mb-0">No industry data available.</p>
        </div>
    </div>
</div>

<!-- Reseller & Commission Analytics -->
<div class="row mb-3">
    <!-- Reseller Performance -->
    <div class="col-lg-8">
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">Top Performing Resellers</h5>
                <a href="{% url 'platform_admin:resellers-list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Reseller</th>
                            <th>Businesses</th>
                            <th>Revenue Generated</th>
                            <th>Commission Earned</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-muted">No data available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Commission Overview -->
    <div class="col-lg-4">
        <div class="content-card">
            <h5 class="mb-4">Commission Overview</h5>
            <canvas id="commissionChart" height="200"></canvas>
            
        </div>
    </div>
</div>

<!-- User Activity & Engagement -->
<div class="row mb-3">
    <div class="col-12">
        <div class="content-card">
            <h5 class="mb-4">User Activity & Engagement</h5>
            <div class="row">
                <div class="col-lg-8">
                    <canvas id="userActivityChart" height="100"></canvas>
                </div>
                <div class="col-lg-4">
                    <div class="row">
                        <div class="col-12">
                            <p class="text-muted mb-0">No user metrics data available.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Geographic & Device Analytics -->
<div class="row mb-2">
    <!-- Geographic Distribution -->
    <div class="col-lg-6">
        <div class="content-card">
            <h5 class="mb-4">Geographic Distribution</h5>
            
            <p class="text-muted mb-0">No geographic data available.</p>
        </div>
    </div>
    
    <!-- Device & Browser Analytics -->
    <div class="col-lg-6">
        <div class="content-card">
            <h5 class="mb-4">Device & Browser Usage</h5>
            
            <p class="text-muted mb-0">No device/browser data available.</p>
        </div>
    </div>
</div>

</div>

<!-- Modals -->
{% include 'dashboards/admin/modals/generate-report.html' with report_type="analytics" %}
{% include 'dashboards/admin/modals/date-range.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize charts
    initializeAnalyticsCharts();
    // Initialize 'More analytics' collapse toggle and persist state
    const more = document.getElementById('analyticsMore');
    const toggleBtn = document.getElementById('analyticsMoreToggle');
    if (more && toggleBtn) {
        const instance = new bootstrap.Collapse(more, { toggle: false });
        const saved = localStorage.getItem('analyticsMoreOpen') === 'true';
        if (saved) {
            instance.show();
            toggleBtn.textContent = 'Hide extra analytics';
        }
        more.addEventListener('shown.bs.collapse', function() {
            toggleBtn.textContent = 'Hide extra analytics';
            localStorage.setItem('analyticsMoreOpen', 'true');
        });
        more.addEventListener('hidden.bs.collapse', function() {
            toggleBtn.textContent = 'Show more analytics';
            localStorage.setItem('analyticsMoreOpen', 'false');
        });
    }
});

function initializeAnalyticsCharts() {
    // Revenue & Growth Chart
    const revenueCtx = document.getElementById('revenueGrowthChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Revenue',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Growth Rate',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Revenue ($)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Growth Rate (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
    
    // Plan Distribution Chart
    const planCtx = document.getElementById('planDistributionChart').getContext('2d');
    new Chart(planCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['#10b981', '#3b82f6', '#06b6d4']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // User Activity Chart
    const activityCtx = document.getElementById('userActivityChart').getContext('2d');
    new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Active Users',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}
</script>
{% endblock %}
