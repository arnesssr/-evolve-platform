{% extends 'dashboards/admin/layouts/admin-base.html' %}
{% load static %}

{% block title %}Report Generator{% endblock %}

{% block page_title %}Report Generator{% endblock %}
{% block page_subtitle %}Generate custom reports and analytics{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'platform_admin:dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item active">Reports</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" id="generateReportBtn">
        <i class="fas fa-file-export me-2"></i>Generate Report
    </button>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
{% include 'dashboards/admin/components/reports-tabs.html' with active='reports-generate' %}

<!-- Report Configuration -->
<div class="row">
    <!-- Report Settings -->
    <div class="col-lg-8">
        <div class="content-card">
            <h5 class="mb-4">Report Configuration</h5>
            
            <form id="reportForm">
                <!-- Report Type -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="reportType" class="form-label">Report Type</label>
                        <select id="reportType" class="form-select">
                            <option value="">Select Report Type</option>
                            <option value="revenue_summary">Revenue Summary</option>
                            <option value="commission_report">Commission Report</option>
                            <option value="payout_report">Payout Report</option>
                            <option value="financial_overview">Financial Overview</option>
                            <option value="cash_flow_statement">Cash Flow Statement</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="reportFormat" class="form-label">Output Format</label>
                        <select id="reportFormat" class="form-select">
                            <option value="pdf">PDF Document</option>
                            <option value="excel">Excel Spreadsheet</option>
                            <option value="csv">CSV File</option>
                            <option value="html">HTML Report</option>
                        </select>
                    </div>
                </div>

                <!-- Date Range -->
                <div class="mb-4">
                    <label class="form-label">Date Range</label>
                    <div class="row">
                        <div class="col-md-4">
                            <select id="datePreset" class="form-select">
                                <option value="">Custom Range</option>
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="last7days">Last 7 Days</option>
                                <option value="last30days">Last 30 Days</option>
                                <option value="thismonth">This Month</option>
                                <option value="lastmonth">Last Month</option>
                                <option value="thisquarter">This Quarter</option>
                                <option value="thisyear">This Year</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="startDate" class="form-control" placeholder="Start Date">
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="endDate" class="form-control" placeholder="End Date">
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
    
    <!-- Report Preview & History -->
    <div class="col-lg-4">
        <!-- Report Preview -->
        <div class="content-card mb-4">
            <h5 class="mb-4">Report Preview</h5>
            
            <div id="reportPreview" class="text-center text-muted">
                <i class="fas fa-file-alt fa-3x mb-3"></i>
                <p>Select report type and options to see preview</p>
            </div>
            
            <div id="reportSummary" class="d-none">
                <div class="small">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Report Type:</span>
                        <span id="previewType" class="fw-bold"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Date Range:</span>
                        <span id="previewDates" class="fw-bold"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Format:</span>
                        <span id="previewFormat" class="fw-bold"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Estimated Size:</span>
                        <span id="previewSize" class="fw-bold"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Generation Time:</span>
                        <span id="previewTime" class="fw-bold"></span>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<!-- Modals -->
{% include 'dashboards/admin/modals/generate-report.html' with report_type="custom" %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
$(document).ready(function() {
    // Initialize date pickers
    flatpickr("#startDate", {
        dateFormat: "Y-m-d",
    });
    
    flatpickr("#endDate", {
        dateFormat: "Y-m-d",
    });
    
    
    // Date preset handling
    $('#datePreset').change(function() {
        const preset = $(this).val();
        if (preset) {
            const dates = getPresetDates(preset);
            $('#startDate')[0]._flatpickr.setDate(dates.start);
            $('#endDate')[0]._flatpickr.setDate(dates.end);
        }
    });
    
    // Form change handler for preview
    $('#reportForm input, #reportForm select').change(function() {
        updateReportPreview();
    });
    
    // Generate report button opens the modal
    $('#generateReportBtn').click(function() {
        if (typeof showGenerateReportModal === 'function') {
            showGenerateReportModal();
        }
    });
});


function getPresetDates(preset) {
    const today = new Date();
    const dates = { start: null, end: null };
    
    switch(preset) {
        case 'today':
            dates.start = dates.end = today;
            break;
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            dates.start = dates.end = yesterday;
            break;
        case 'last7days':
            dates.end = today;
            dates.start = new Date(today);
            dates.start.setDate(today.getDate() - 6);
            break;
        case 'last30days':
            dates.end = today;
            dates.start = new Date(today);
            dates.start.setDate(today.getDate() - 29);
            break;
        case 'thismonth':
            dates.start = new Date(today.getFullYear(), today.getMonth(), 1);
            dates.end = today;
            break;
        case 'lastmonth':
            dates.start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            dates.end = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
    }
    
    return dates;
}

function updateReportPreview() {
    const reportType = $('#reportType').val();
    const format = $('#reportFormat').val();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    
    if (reportType) {
        $('#reportPreview').addClass('d-none');
        $('#reportSummary').removeClass('d-none');
        
        $('#previewType').text(reportType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()));
        $('#previewFormat').text(format.toUpperCase());
        $('#previewDates').text(startDate && endDate ? `${startDate} to ${endDate}` : 'Not specified');
        $('#previewSize').text('');
        $('#previewTime').text('');
    } else {
        $('#reportPreview').removeClass('d-none');
        $('#reportSummary').addClass('d-none');
    }
}


function generateReport() {
    // No mock generation here; implement real generation via API when ready
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.content').prepend(alertHtml);
}
</script>
{% endblock %}
