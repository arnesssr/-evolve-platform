<!-- Email Template Editor Form Component -->
<div class="email-template-editor">
    <form id="emailTemplateForm" method="POST">
        {% csrf_token %}
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-semibold">
                        <i class="fas fa-envelope text-primary me-2"></i>
                        Email Template Editor
                    </h6>
                    <div class="template-actions">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="previewTemplate()">
                            <i class="fas fa-eye me-1"></i>Preview
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="testEmail()">
                            <i class="fas fa-paper-plane me-1"></i>Send Test
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Template Selection -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Template Type</label>
                        <select class="form-select" name="template_type" id="templateType" onchange="loadTemplate()">
                            <option value="">Select Template</option>
                            <option value="welcome">Welcome Email</option>
                            <option value="password_reset">Password Reset</option>
                            <option value="commission_earned">Commission Earned</option>
                            <option value="payout_processed">Payout Processed</option>
                            <option value="plan_upgrade">Plan Upgrade</option>
                            <option value="subscription_expired">Subscription Expired</option>
                            <option value="invoice_generated">Invoice Generated</option>
                            <option value="payment_failed">Payment Failed</option>
                            <option value="account_suspended">Account Suspended</option>
                            <option value="monthly_report">Monthly Report</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Language</label>
                        <select class="form-select" name="language">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="pt">Portuguese</option>
                        </select>
                    </div>
                </div>
                
                <!-- Email Basic Info -->
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label class="form-label fw-medium">Subject Line</label>
                        <input type="text" class="form-control" name="subject" 
                               placeholder="Enter email subject line..." 
                               value="{{ template.subject|default:'' }}">
                        <small class="form-text text-muted">
                            Available variables: {{user_name}}, {{company_name}}, {{amount}}, {{date}}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-medium">From Name</label>
                        <input type="text" class="form-control" name="from_name" 
                               value="{{ template.from_name|default:'Evolve Platform' }}">
                    </div>
                </div>
                
                <!-- Template Content -->
                <div class="template-content mb-4">
                    <label class="form-label fw-medium">Email Content</label>
                    <div class="editor-container">
                        <div class="editor-toolbar mb-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')">
                                    <i class="fas fa-underline"></i>
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm ms-2" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="insertVariable('user_name')">
                                    User Name
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertVariable('company_name')">
                                    Company
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertVariable('amount')">
                                    Amount
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertVariable('date')">
                                    Date
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" name="content" id="emailContent" rows="12"
                                  placeholder="Enter your email content here...">{{ template.content|default:'' }}</textarea>
                    </div>
                </div>
                
                <!-- Template Settings -->
                <div class="template-settings">
                    <h6 class="text-muted mb-3">Template Settings</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_active" 
                                       {% if template.is_active %}checked{% endif %}>
                                <label class="form-check-label">Active Template</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="auto_send" 
                                       {% if template.auto_send %}checked{% endif %}>
                                <label class="form-check-label">Auto Send</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Priority</label>
                            <select class="form-select" name="priority">
                                <option value="low" {% if template.priority == 'low' %}selected{% endif %}>Low</option>
                                <option value="normal" {% if template.priority == 'normal' %}selected{% endif %}>Normal</option>
                                <option value="high" {% if template.priority == 'high' %}selected{% endif %}>High</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Email Styling -->
                <div class="email-styling mt-4">
                    <h6 class="text-muted mb-3">Email Styling</h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Header Color</label>
                            <input type="color" class="form-control form-control-color" name="header_color" 
                                   value="{{ template.header_color|default:'#007bff' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Button Color</label>
                            <input type="color" class="form-control form-control-color" name="button_color" 
                                   value="{{ template.button_color|default:'#28a745' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Font Family</label>
                            <select class="form-select" name="font_family">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Logo URL</label>
                            <input type="url" class="form-control" name="logo_url" 
                                   value="{{ template.logo_url|default:'' }}" placeholder="https://...">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="template-info">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Last modified: {{ template.updated_at|default:'Never' }}
                        </small>
                    </div>
                    <div class="actions">
                        <button type="button" class="btn btn-outline-secondary" onclick="resetTemplate()">
                            <i class="fas fa-undo me-1"></i>Reset
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="email-preview-container">
                    <div class="preview-header">
                        <strong>Subject:</strong> <span id="previewSubject"></span>
                    </div>
                    <div class="preview-content mt-3" id="previewContent">
                        <!-- Email content will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Email Modal -->
<div class="modal fade" id="testEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Test Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Test Email Address</label>
                    <input type="email" class="form-control" id="testEmailAddress" 
                           placeholder="Enter email address for testing">
                </div>
                <div class="mb-3">
                    <label class="form-label">Test Data (JSON format)</label>
                    <textarea class="form-control" id="testData" rows="4" 
                              placeholder='{"user_name": "John Doe", "amount": "$100.00"}'></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendTestEmail()">Send Test</button>
            </div>
        </div>
    </div>
</div>

<style>
.email-template-editor .card { border-radius: 10px; }
.editor-container { border: 1px solid #dee2e6; border-radius: 6px; }
.editor-toolbar { padding: 0.5rem; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
.email-preview-container { padding: 1rem; border: 1px solid #dee2e6; border-radius: 6px; background: #fff; }
.preview-header { padding: 0.75rem; background: #f8f9fa; border-radius: 4px; }
.preview-content { min-height: 200px; }
</style>

<script>
const emailTemplates = {
    welcome: {
        subject: 'Welcome to {{company_name}}!',
        content: 'Dear {{user_name}},\n\nWelcome to our platform! We\'re excited to have you on board.\n\nBest regards,\nThe {{company_name}} Team'
    },
    password_reset: {
        subject: 'Password Reset Request',
        content: 'Hi {{user_name}},\n\nYou have requested to reset your password. Please click the link below to proceed.\n\nIf you didn\'t request this, please ignore this email.'
    },
    commission_earned: {
        subject: 'Commission Earned - {{amount}}',
        content: 'Congratulations {{user_name}}!\n\nYou have earned a commission of {{amount}} on {{date}}.\n\nKeep up the great work!'
    }
};

function loadTemplate() {
    const templateType = document.getElementById('templateType').value;
    if (templateType && emailTemplates[templateType]) {
        const template = emailTemplates[templateType];
        document.querySelector('[name="subject"]').value = template.subject;
        document.getElementById('emailContent').value = template.content;
    }
}

function formatText(command) {
    const textarea = document.getElementById('emailContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    if (selectedText) {
        let formattedText = '';
        switch (command) {
            case 'bold':
                formattedText = `<strong>${selectedText}</strong>`;
                break;
            case 'italic':
                formattedText = `<em>${selectedText}</em>`;
                break;
            case 'underline':
                formattedText = `<u>${selectedText}</u>`;
                break;
        }
        
        textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    }
}

function insertVariable(variable) {
    const textarea = document.getElementById('emailContent');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    textarea.value = textBefore + `{{${variable}}}` + textAfter;
    textarea.focus();
}

function previewTemplate() {
    const subject = document.querySelector('[name="subject"]').value;
    const content = document.getElementById('emailContent').value;
    
    document.getElementById('previewSubject').textContent = subject;
    document.getElementById('previewContent').innerHTML = content.replace(/\n/g, '<br>');
    
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function testEmail() {
    new bootstrap.Modal(document.getElementById('testEmailModal')).show();
}

function sendTestEmail() {
    const email = document.getElementById('testEmailAddress').value;
    const testData = document.getElementById('testData').value;
    
    if (!email) {
        alert('Please enter a test email address');
        return;
    }
    
    // Simulate sending test email
    const loadingBtn = event.target;
    loadingBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
    loadingBtn.disabled = true;
    
    setTimeout(() => {
        loadingBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Test';
        loadingBtn.disabled = false;
        alert('Test email sent successfully!');
        bootstrap.Modal.getInstance(document.getElementById('testEmailModal')).hide();
    }, 2000);
}

function resetTemplate() {
    if (confirm('Reset template to default values?')) {
        document.getElementById('emailTemplateForm').reset();
    }
}

// Auto-save functionality
let autoSaveTimer;
document.getElementById('emailContent').addEventListener('input', function() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        // Auto-save draft
        console.log('Auto-saving template draft...');
    }, 3000);
});
</script>
