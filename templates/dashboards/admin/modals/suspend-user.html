<!-- Suspend User Modal Component -->
<div class="modal fade" id="suspendUserModal" tabindex="-1" aria-labelledby="suspendUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="suspendUserModalLabel">
                    <i class="fas fa-ban me-2"></i>Suspend User Account
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <!-- User Information -->
                <div class="user-info mb-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    <i class="fas fa-user-circle fa-3x text-muted"></i>
                                </div>
                                <div>
<h6 class="mb-1" id="suspendUserName">{{ reseller.name|default:"—" }}</h6>
<p class="mb-1 text-muted" id="suspendUserEmail">{{ reseller.email|default:"—" }}</p>
<small class="text-muted">User ID: <span id="suspendUserId">{{ reseller.id }}</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Suspension Reason -->
                <div class="suspension-reason mb-4">
                    <label class="form-label fw-bold">Reason for Suspension <span class="text-danger">*</span></label>
                    <select class="form-select mb-3" id="suspensionReason" onchange="toggleCustomReason()">
                        <option value="">Select a reason...</option>
                        <option value="policy_violation">Policy Violation</option>
                        <option value="fraudulent_activity">Fraudulent Activity</option>
                        <option value="payment_issues">Payment Issues</option>
                        <option value="spam_abuse">Spam/Abuse</option>
                        <option value="security_concerns">Security Concerns</option>
                        <option value="account_compromise">Account Compromise</option>
                        <option value="terms_violation">Terms of Service Violation</option>
                        <option value="other">Other</option>
                    </select>
                    
                    <div id="customReasonSection" style="display: none;">
                        <label class="form-label">Custom Reason</label>
                        <input type="text" class="form-control" id="customReason" placeholder="Enter custom reason...">
                    </div>
                </div>
                
                <!-- Detailed Description -->
                <div class="detailed-description mb-4">
                    <label class="form-label fw-bold">Detailed Description</label>
                    <textarea class="form-control" id="suspensionDescription" rows="4" 
                              placeholder="Provide detailed explanation for the suspension..."></textarea>
                    <small class="form-text text-muted">This information will be logged and may be shared with the user</small>
                </div>
                
                <!-- Suspension Duration -->
                <div class="suspension-duration mb-4">
                    <label class="form-label fw-bold">Suspension Duration</label>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="durationType" id="temporary" value="temporary" checked onchange="updateDurationFields()">
                                <label class="form-check-label" for="temporary">
                                    <i class="fas fa-clock text-warning me-1"></i>Temporary Suspension
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="durationType" id="permanent" value="permanent" onchange="updateDurationFields()">
                                <label class="form-check-label" for="permanent">
                                    <i class="fas fa-ban text-danger me-1"></i>Permanent Suspension
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="temporaryDurationSection" class="mt-3">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Duration</label>
                                <select class="form-select" id="suspensionDuration">
                                    <option value="1">1 Day</option>
                                    <option value="3">3 Days</option>
                                    <option value="7" selected>1 Week</option>
                                    <option value="14">2 Weeks</option>
                                    <option value="30">1 Month</option>
                                    <option value="90">3 Months</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="suspensionEndDate" readonly>
                            </div>
                        </div>
                        
                        <div id="customDurationSection" class="mt-2" style="display: none;">
                            <label class="form-label">Custom End Date</label>
                            <input type="date" class="form-control" id="customEndDate">
                        </div>
                    </div>
                </div>
                
                <!-- Actions During Suspension -->
                <div class="suspension-actions mb-4">
                    <label class="form-label fw-bold">Actions During Suspension</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="blockLogin" checked>
                        <label class="form-check-label" for="blockLogin">
                            Block user login access
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="freezeCommissions" checked>
                        <label class="form-check-label" for="freezeCommissions">
                            Freeze commission earnings
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="blockPayouts">
                        <label class="form-check-label" for="blockPayouts">
                            Block pending payouts
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="notifyUser" checked>
                        <label class="form-check-label" for="notifyUser">
                            Send notification email to user
                        </label>
                    </div>
                </div>
                
                <!-- Warning Message -->
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Suspending this user will immediately restrict their access and may affect their ongoing transactions and commissions.
                </div>
            </div>
            
            <div class="modal-footer">
                <form method="post" action="{% url 'platform_admin:reseller-suspend' reseller.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="reason" id="suspendReasonHidden" />
                    <input type="hidden" name="description" id="suspendDescriptionHidden" />
                    <input type="hidden" name="durationType" id="suspendDurationTypeHidden" />
                    <input type="hidden" name="suspensionDuration" id="suspendDurationHidden" />
                    <input type="hidden" name="endDate" id="suspendEndDateHidden" />
                    <input type="hidden" name="blockLogin" id="suspendBlockLoginHidden" />
                    <input type="hidden" name="freezeCommissions" id="suspendFreezeCommissionsHidden" />
                    <input type="hidden" name="blockPayouts" id="suspendBlockPayoutsHidden" />
                    <input type="hidden" name="notifyUser" id="suspendNotifyUserHidden" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" onclick="prepareSuspendSubmit()" id="suspendBtn" disabled>
                        <i class="fas fa-ban me-1"></i>Suspend User
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentSuspendUserId = null;

function showSuspendUserModal(userData) {
    if (userData && userData.id) {
        currentSuspendUserId = userData.id;
    }
    
    // Populate user information (only override if provided)
    if (userData && userData.name) {
        document.getElementById('suspendUserName').textContent = userData.name;
    }
    if (userData && userData.email) {
        document.getElementById('suspendUserEmail').textContent = userData.email;
    }
    if (userData && userData.id) {
        document.getElementById('suspendUserId').textContent = userData.id;
    }
    
    // Reset form
    resetSuspensionForm();
    
    // Set initial end date
    updateSuspensionEndDate();
    
    const modal = new bootstrap.Modal(document.getElementById('suspendUserModal'));
    modal.show();
}

function resetSuspensionForm() {
    document.getElementById('suspensionReason').value = '';
    document.getElementById('customReason').value = '';
    document.getElementById('suspensionDescription').value = '';
    document.getElementById('temporary').checked = true;
    document.getElementById('suspensionDuration').value = '7';
    document.getElementById('customEndDate').value = '';
    
    // Reset checkboxes
    document.getElementById('blockLogin').checked = true;
    document.getElementById('freezeCommissions').checked = true;
    document.getElementById('blockPayouts').checked = false;
    document.getElementById('notifyUser').checked = true;
    
    // Hide conditional sections
    document.getElementById('customReasonSection').style.display = 'none';
    document.getElementById('temporaryDurationSection').style.display = 'block';
    document.getElementById('customDurationSection').style.display = 'none';
    
    validateSuspensionForm();
}

function toggleCustomReason() {
    const reason = document.getElementById('suspensionReason').value;
    const customSection = document.getElementById('customReasonSection');
    
    if (reason === 'other') {
        customSection.style.display = 'block';
    } else {
        customSection.style.display = 'none';
    }
    
    validateSuspensionForm();
}

function updateDurationFields() {
    const durationType = document.querySelector('input[name="durationType"]:checked').value;
    const temporarySection = document.getElementById('temporaryDurationSection');
    
    if (durationType === 'temporary') {
        temporarySection.style.display = 'block';
        updateSuspensionEndDate();
    } else {
        temporarySection.style.display = 'none';
    }
}

function updateSuspensionEndDate() {
    const duration = document.getElementById('suspensionDuration').value;
    const endDateField = document.getElementById('suspensionEndDate');
    
    if (duration === 'custom') {
        document.getElementById('customDurationSection').style.display = 'block';
        endDateField.value = '';
    } else {
        document.getElementById('customDurationSection').style.display = 'none';
        
        if (duration) {
            const startDate = new Date();
            const endDate = new Date(startDate.getTime() + (parseInt(duration) * 24 * 60 * 60 * 1000));
            endDateField.value = endDate.toISOString().split('T')[0];
        }
    }
}

function validateSuspensionForm() {
    const reason = document.getElementById('suspensionReason').value;
    const customReason = document.getElementById('customReason').value;
    const suspendBtn = document.getElementById('suspendBtn');
    
    let isValid = reason !== '';
    
    // If "other" is selected, custom reason is required
    if (reason === 'other') {
        isValid = isValid && customReason.trim() !== '';
    }
    
    suspendBtn.disabled = !isValid;
}

function prepareSuspendSubmit() {
    const reason = document.getElementById('suspensionReason').value;
    const customReason = document.getElementById('customReason').value;
    const description = document.getElementById('suspensionDescription').value;
    const durationType = document.querySelector('input[name="durationType"]:checked').value;
    
    // Get final reason
    let finalReason = reason;
    if (reason === 'other') {
        finalReason = customReason;
    }
    
    // Get end date for temporary suspension
    let endDate = null;
    if (durationType === 'temporary') {
        const duration = document.getElementById('suspensionDuration').value;
        if (duration === 'custom') {
            endDate = document.getElementById('customEndDate').value;
        } else {
            endDate = document.getElementById('suspensionEndDate').value;
        }
    }
    
    // Prepare suspension data
    const suspensionData = {
        userId: currentSuspendUserId,
        reason: finalReason,
        description: description,
        durationType: durationType,
        endDate: endDate,
        blockLogin: document.getElementById('blockLogin').checked,
        freezeCommissions: document.getElementById('freezeCommissions').checked,
        blockPayouts: document.getElementById('blockPayouts').checked,
        notifyUser: document.getElementById('notifyUser').checked,
        suspendedBy: 'Current Admin',
        suspendedAt: new Date().toISOString()
    };
    
    // Final confirmation
    let confirmMessage = `Are you sure you want to suspend this user?\n\nReason: ${finalReason}`;
    if (durationType === 'temporary' && endDate) {
        confirmMessage += `\nUntil: ${endDate}`;
    } else if (durationType === 'permanent') {
        confirmMessage += '\nDuration: Permanent';
    }
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Populate hidden inputs then allow form to submit
    document.getElementById('suspendReasonHidden').value = finalReason;
    document.getElementById('suspendDescriptionHidden').value = description;
    document.getElementById('suspendDurationTypeHidden').value = durationType;
    document.getElementById('suspendDurationHidden').value = document.getElementById('suspensionDuration').value;
    document.getElementById('suspendEndDateHidden').value = endDate || '';
    document.getElementById('suspendBlockLoginHidden').value = document.getElementById('blockLogin').checked ? 'on' : '';
    document.getElementById('suspendFreezeCommissionsHidden').value = document.getElementById('freezeCommissions').checked ? 'on' : '';
    document.getElementById('suspendBlockPayoutsHidden').value = document.getElementById('blockPayouts').checked ? 'on' : '';
    document.getElementById('suspendNotifyUserHidden').value = document.getElementById('notifyUser').checked ? 'on' : '';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with page reseller context
    try { currentSuspendUserId = parseInt('{{ reseller.id }}'); } catch(e) { /* noop */ }

    // Validate form when reason changes
    document.getElementById('suspensionReason').addEventListener('change', validateSuspensionForm);
    document.getElementById('customReason').addEventListener('input', validateSuspensionForm);
    
    // Update end date when duration changes
    document.getElementById('suspensionDuration').addEventListener('change', updateSuspensionEndDate);
});
</script>
