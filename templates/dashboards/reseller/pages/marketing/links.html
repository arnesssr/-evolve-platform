{% extends "dashboards/reseller/layouts/reseller-base.html" %}
{% load static %}

{% block title %}Referral Links - Reseller Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'reseller/css/reseller-components.css' %}">
{% endblock %}

{% block content %}
<div class="referral-links">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <h1 class="h3 mb-0">Referral Link Generator</h1>
        <p class="text-muted mb-0">Create and manage your unique referral links</p>
    </div>

    <!-- Link Generator -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Generate New Link</h5>
        </div>
        <div class="card-body">
            <form id="linkGeneratorForm">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Campaign Name</label>
                        <input type="text" class="form-control" name="campaign_name" placeholder="e.g., Summer Promo 2024" required>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Product</label>
                        <select class="form-select" name="product" required>
                            <option value="">Select Product</option>
                            <option value="payroll">Payroll</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3 d-flex align-items-center gap-3">
                    <button type="submit" class="btn btn-primary" id="generateLinkBtn">
                        <span class="spinner-border spinner-border-sm me-2 d-none" id="generateSpinner" role="status" aria-hidden="true"></span>
                        <span id="generateBtnText">Generate Link</span>
                    </button>
                    <div id="linkError" class="alert alert-danger d-none mb-0 py-2 px-3" role="alert" style="font-size: 0.9rem;"></div>
                </div>
            </form>

            <!-- Generated Link Display -->
            <div id="generatedLinkSection" class="mt-4" style="display: none;">
                <div class="alert alert-success">
                    <h6 class="alert-heading">Your referral link has been generated!</h6>
                    <div class="input-group mt-2">
                        <input type="text" class="form-control" id="generatedLink" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyLink()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Links -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Your Active Links</h5>
            <span class="badge bg-primary"><span id="activeLinksCount">0</span> Active Links</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover responsive-stack">
                    <thead>
                        <tr>
                            <th>Campaign</th>
                            <th>Product</th>
                            <th>Link</th>
                            <th>Clicks</th>
                            <th>Conversions</th>
                            <th>Earnings</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="linksTbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Link generation and management functions
    const API_BASE = '/platform/api/v1';

    function getCsrfToken() {
        const name = 'csrftoken=';
        const decodedCookie = decodeURIComponent(document.cookie || '');
        const ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i].trim();
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return '';
    }

    function randomString(len) {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let out = '';
        for (let i = 0; i < len; i++) {
            out += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return out;
    }

    function generateCode(prefix) {
        return `${prefix}-${randomString(8)}`;
    }

    function formatDate(d) {
        try {
            const dt = new Date(d);
            if (!isNaN(dt.getTime())) return dt.toLocaleDateString();
        } catch (_) {}
        return '';
    }

    function buildShareUrl(item) {
        // Use short link resolver so clicks are tracked server-side
        return `${window.location.origin}/r/${encodeURIComponent(item.code)}`;
    }

    function renderLinksTable(items, totalCount) {
        const tbody = document.getElementById('linksTbody');
        const countEl = document.getElementById('activeLinksCount');
        if (!tbody) return;
        tbody.innerHTML = '';

        const count = typeof totalCount === 'number' ? totalCount : (Array.isArray(items) ? items.length : 0);

        if (!Array.isArray(items) || items.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <p class="mb-0">No referral links created yet.</p>
                        <p class="text-muted small">Generate your first link using the form above!</p>
                    </td>
                </tr>`;
            if (countEl) countEl.textContent = String(count);
            return;
        }

        const rows = items.map(item => {
            const shareUrl = buildShareUrl(item);
            const created = formatDate(item.created_at);
            const conversions = (typeof item.conversions === 'number') ? item.conversions : 0;
            const earnings = item.earnings ? item.earnings : '0.00';
            return `
                <tr>
                    <td data-label="Campaign">
                        <div class="fw-medium">${item.title || ''}</div>
                        <div class="text-muted small">Direct</div>
                    </td>
                    <td data-label="Product">
                        <span class="badge bg-secondary">Payroll</span>
                    </td>
                    <td data-label="Link">
                        <div class="link-wrapper">
                            <code class="small">${shareUrl}</code>
                            <button class="btn btn-sm btn-link" onclick="copyLinkToClipboard('${shareUrl}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </td>
                    <td data-label="Clicks">${item.clicks ?? 0}</td>
                    <td data-label="Conversions"><span class="text-success">${conversions}</span></td>
                    <td data-label="Earnings">KES ${earnings}</td>
                    <td data-label="Created">${created}</td>
                    <td data-label="Actions">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="copyLinkToClipboard('${shareUrl}')" title="Copy link">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });

        tbody.innerHTML = rows.join('');
        if (countEl) countEl.textContent = String(count);
    }

    async function fetchAndRenderLinks() {
        try {
            const resp = await fetch(`${API_BASE}/marketing/links/`, { credentials: 'include' });
            if (!resp.ok) throw new Error(`Failed to fetch links: ${resp.status}`);
            const data = await resp.json();
            const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
            const total = Array.isArray(data) ? data.length : (typeof data.count === 'number' ? data.count : items.length);
            renderLinksTable(items, total);
        } catch (e) {
            console.error(e);
            renderLinksTable([], 0);
        }
    }

    document.getElementById('linkGeneratorForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.currentTarget;
        const btn = document.getElementById('generateLinkBtn');
        const spinner = document.getElementById('generateSpinner');
        const btnText = document.getElementById('generateBtnText');
        const errBox = document.getElementById('linkError');
        const controls = form.querySelectorAll('input, select, button');

        // Reset error box
        if (errBox) {
            errBox.classList.add('d-none');
            errBox.textContent = '';
        }

        const campaignName = (form.elements['campaign_name']?.value || '').trim();
        const product = form.elements['product']?.value || '';
        if (product !== 'payroll') {
            if (errBox) {
                errBox.textContent = 'Please select Payroll.';
                errBox.classList.remove('d-none');
            }
            return;
        }

        const title = campaignName || 'Payroll';
        const code = generateCode('PAY');
        const destinationUrl = `${window.location.origin}/payroll/subscribe/`;

        const payload = {
            title: title,
            code: code,
            destination_url: destinationUrl,
            is_active: true
        };

        // Set loading state
        controls.forEach(el => el.disabled = true);
        if (btn) btn.disabled = true;
        if (spinner) spinner.classList.remove('d-none');
        if (btnText) btnText.textContent = 'Generating...';

        try {
            const resp = await fetch(`${API_BASE}/marketing/links/`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(payload)
            });

            if (!resp.ok) {
                const text = await resp.text();
                throw new Error(text || `Request failed with ${resp.status}`);
            }

            const data = await resp.json();
            // Shareable link: use short-link resolver so clicks are tracked
            const shareUrl = `${window.location.origin}/r/${encodeURIComponent(data.code)}`;
            const linkInput = document.getElementById('generatedLink');
            if (linkInput) linkInput.value = shareUrl;

            const section = document.getElementById('generatedLinkSection');
            if (section) section.style.display = 'block';

            // Refresh table so the newly created link appears
            await fetchAndRenderLinks();
        } catch (err) {
            console.error('Failed to create link', err);
            if (errBox) {
                // Truncate very long HTML error bodies for safety
                let msg = String(err && err.message ? err.message : err || 'Unknown error');
                if (msg.length > 300) msg = msg.slice(0, 300) + '...';
                errBox.textContent = `Could not create link. ${msg}`;
                errBox.classList.remove('d-none');
            }
        } finally {
            // Restore controls
            controls.forEach(el => el.disabled = false);
            if (btn) btn.disabled = false;
            if (spinner) spinner.classList.add('d-none');
            if (btnText) btnText.textContent = 'Generate Link';
        }
    });

    function copyLink() {
        const linkInput = document.getElementById('generatedLink');
        const value = linkInput && linkInput.value ? linkInput.value : '';
        if (!value) { return; }
        navigator.clipboard.writeText(value).then(() => {
            // Optionally show a non-intrusive notification
        });
    }

    function copyLinkToClipboard(link) {
        navigator.clipboard.writeText(link).then(() => {
            // Show success notification
        });
    }


    function viewLinkStats(linkId) {
        // Navigate to link statistics (optional, not wired for MVP)
        window.location.href = `/reseller/links/${linkId}/stats/`;
    }

    // Load existing links on page load
    fetchAndRenderLinks();
</script>
{% endblock %}
