<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Reset your EvolvePay password">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Forgot Password - EvolvePay</title>
    
    {% load static %}
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/auth.css' %}">
    <link rel="stylesheet" href="{% static 'css/forgot-password.css' %}">
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="blob blob1"></div>
        <div class="blob blob2"></div>
        <div class="blob blob3"></div>
    </div>

    <!-- Back to Login -->
    <a href="{% url 'login' %}" class="back-home">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Login</span>
    </a>

    <!-- Main Container -->
    <div class="auth-container">
        <div class="auth-card">
            <!-- Logo Section -->
            <div class="auth-header">
                <div class="logo">
                    <i class="fas fa-wallet"></i>
                    <span>Evolve<strong>Pay</strong></span>
                </div>
                <h1>Reset Your Password</h1>
                <p>We'll help you get back into your account</p>
            </div>

            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <span>1</span>
                    <p>Select Method</p>
                </div>
                <div class="step" id="step2">
                    <span>2</span>
                    <p>Verify Code</p>
                </div>
                <div class="step" id="step3">
                    <span>3</span>
                    <p>New Password</p>
                </div>
            </div>

            <!-- Step 1: Select Recovery Method -->
            <div class="step-content active" id="step1-content">
                <form class="auth-form">
                    <h3 class="step-title">How would you like to receive your verification code?</h3>
                    
                    <!-- Recovery Method Selection -->
                    <div class="recovery-methods">
                        <label class="method-option">
                            <input type="radio" name="recovery_method" value="email" checked>
                            <div class="method-card">
                                <i class="fas fa-envelope"></i>
                                <div class="method-info">
                                    <strong>Email</strong>
                                    <small>Send code to your registered email</small>
                                </div>
                                <div class="radio-indicator"></div>
                            </div>
                        </label>

                        <label class="method-option">
                            <input type="radio" name="recovery_method" value="phone">
                            <div class="method-card">
                                <i class="fas fa-mobile-alt"></i>
                                <div class="method-info">
                                    <strong>Phone Number</strong>
                                    <small>Send code via SMS</small>
                                </div>
                                <div class="radio-indicator"></div>
                            </div>
                        </label>
                    </div>

                    <!-- Email Input (shown by default) -->
                    <div class="form-group" id="email-input-group">
                        <label for="recovery-email">Email Address</label>
                        <div class="input-wrapper">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="recovery-email" name="email" placeholder="Enter your email address" required>
                        </div>
                    </div>

                    <!-- Phone Input (hidden by default) -->
                    <div class="form-group" id="phone-input-group" style="display: none;">
                        <label for="recovery-phone">Phone Number</label>
                        <div class="input-wrapper">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="recovery-phone" name="phone" placeholder="+1 (555) 123-4567">
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="button" class="btn-submit" onclick="moveToStep2()">
                        <span>Send Verification Code</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </form>
            </div>

            <!-- Step 2: Verify Code -->
            <div class="step-content" id="step2-content">
                <form class="auth-form">
                    <h3 class="step-title">Enter Verification Code</h3>
                    <p class="step-description">We've sent a 6-digit code to <span id="sent-to" class="highlight"></span></p>
                    
                    <!-- Code Input -->
                    <div class="code-input-container">
                        <input type="text" maxlength="1" class="code-input" id="code-1" autocomplete="off">
                        <input type="text" maxlength="1" class="code-input" id="code-2" autocomplete="off">
                        <input type="text" maxlength="1" class="code-input" id="code-3" autocomplete="off">
                        <input type="text" maxlength="1" class="code-input" id="code-4" autocomplete="off">
                        <input type="text" maxlength="1" class="code-input" id="code-5" autocomplete="off">
                        <input type="text" maxlength="1" class="code-input" id="code-6" autocomplete="off">
                    </div>

                    <!-- Timer and Resend -->
                    <div class="code-timer">
                        <p>Didn't receive the code? 
                            <span id="timer" class="timer-text">Resend in 0:59</span>
                            <button type="button" id="resend-btn" class="resend-link" style="display: none;" onclick="resendCode()">Resend Code</button>
                        </p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="button-group">
                        <button type="button" class="btn-secondary" onclick="moveToStep1()">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back</span>
                        </button>
                        <button type="button" class="btn-submit" onclick="moveToStep3()">
                            <span>Verify Code</span>
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 3: New Password -->
            <div class="step-content" id="step3-content">
                <form class="auth-form">
                    <h3 class="step-title">Create New Password</h3>
                    <p class="step-description">Choose a strong password for your account</p>
                    
                    <!-- New Password Input -->
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="new-password" name="new_password" placeholder="Enter new password" required>
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('new-password', 'toggleIcon1')">
                                <i class="fas fa-eye" id="toggleIcon1"></i>
                            </button>
                        </div>
                        <div class="password-requirements">
                            <div class="requirement" id="length-req">
                                <i class="fas fa-circle"></i>
                                <span>At least 8 characters</span>
                            </div>
                            <div class="requirement" id="uppercase-req">
                                <i class="fas fa-circle"></i>
                                <span>One uppercase letter</span>
                            </div>
                            <div class="requirement" id="lowercase-req">
                                <i class="fas fa-circle"></i>
                                <span>One lowercase letter</span>
                            </div>
                            <div class="requirement" id="number-req">
                                <i class="fas fa-circle"></i>
                                <span>One number</span>
                            </div>
                            <div class="requirement" id="special-req">
                                <i class="fas fa-circle"></i>
                                <span>One special character</span>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm Password Input -->
                    <div class="form-group">
                        <label for="confirm-password">Confirm Password</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="confirm-password" name="confirm_password" placeholder="Confirm new password" required>
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirm-password', 'toggleIcon2')">
                                <i class="fas fa-eye" id="toggleIcon2"></i>
                            </button>
                        </div>
                        <span class="error-text" id="password-match-error" style="display: none;">Passwords do not match</span>
                    </div>

                    <!-- Submit Button -->
                    <button type="button" class="btn-submit" onclick="resetPassword()">
                        <span>Reset Password</span>
                        <i class="fas fa-shield-alt"></i>
                    </button>
                </form>
            </div>

            <!-- Success Message -->
            <div class="step-content" id="success-content">
                <div class="success-container">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Password Reset Successful!</h3>
                    <p>Your password has been successfully reset. You can now login with your new password.</p>
                    <a href="{% url 'login' %}" class="btn-submit">
                        <span>Go to Login</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Side Content -->
        <div class="auth-side">
            <div class="side-content">
                <h2>Secure Account Recovery</h2>
                <p>Your security is our priority. We use multi-factor authentication to ensure only you can reset your password.</p>
                
                <div class="features">
                    <div class="feature-item">
                        <i class="fas fa-lock"></i>
                        <span>256-bit Encryption</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-mobile-alt"></i>
                        <span>SMS & Email Verification</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-user-shield"></i>
                        <span>Account Protection</span>
                    </div>
                </div>

                <div class="security-tips">
                    <h4>Security Tips:</h4>
                    <ul>
                        <li>Never share your verification code with anyone</li>
                        <li>Choose a unique password you haven't used before</li>
                        <li>Enable two-factor authentication for extra security</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get CSRF token from meta tag
        function getCSRFToken() {
            return document.querySelector('[name=csrf-token]').getAttribute('content');
        }
        
        // Recovery method toggle
        document.querySelectorAll('input[name="recovery_method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'email') {
                    document.getElementById('email-input-group').style.display = 'block';
                    document.getElementById('phone-input-group').style.display = 'none';
                } else {
                    document.getElementById('email-input-group').style.display = 'none';
                    document.getElementById('phone-input-group').style.display = 'block';
                }
            });
        });

        // Step navigation
        function moveToStep1() {
            setActiveStep(1);
        }

        async function moveToStep2() {
            const method = document.querySelector('input[name="recovery_method"]:checked').value;
            const value = method === 'email' 
                ? document.getElementById('recovery-email').value 
                : document.getElementById('recovery-phone').value;
            
            if (!value) {
                alert('Please enter your ' + method);
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>Sending...</span><i class="fas fa-spinner fa-spin"></i>';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/api/password-reset/send-code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({
                        recovery_method: method,
                        contact_value: value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update the sent-to text with masked contact
                    document.getElementById('sent-to').textContent = data.contact_masked || value;
                    
                    setActiveStep(2);
                    startTimer();
                    
                    // Focus on first code input
                    document.getElementById('code-1').focus();
                } else {
                    alert(data.message || 'Failed to send verification code');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function moveToStep3() {
            const code = Array.from({length: 6}, (_, i) => 
                document.getElementById(`code-${i + 1}`).value
            ).join('');
            
            if (code.length !== 6) {
                alert('Please enter the complete 6-digit code');
                return;
            }
            
            // Show loading state
            const verifyBtn = document.querySelector('#step2-content .btn-submit');
            const originalText = verifyBtn.innerHTML;
            verifyBtn.innerHTML = '<span>Verifying...</span><i class="fas fa-spinner fa-spin"></i>';
            verifyBtn.disabled = true;
            
            try {
                const response = await fetch('/api/password-reset/verify-code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    setActiveStep(3);
                } else {
                    alert(data.message || 'Invalid verification code');
                    // Clear code inputs
                    document.querySelectorAll('.code-input').forEach(input => {
                        input.value = '';
                    });
                    document.getElementById('code-1').focus();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            } finally {
                // Restore button state
                verifyBtn.innerHTML = originalText;
                verifyBtn.disabled = false;
            }
        }

        function setActiveStep(stepNumber) {
            // Update progress steps
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index < stepNumber) {
                    step.classList.add('active');
                } else if (index === stepNumber - 1) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step${stepNumber}-content`).classList.add('active');
        }

        // Code input handling
        document.querySelectorAll('.code-input').forEach((input, index) => {
            input.addEventListener('input', function(e) {
                if (this.value.length === 1 && index < 5) {
                    document.getElementById(`code-${index + 2}`).focus();
                }
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && index > 0) {
                    document.getElementById(`code-${index}`).focus();
                }
            });
            
            // Only allow numbers
            input.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
        });

        // Timer functionality
        let timerInterval;
        function startTimer() {
            let seconds = 59;
            const timerElement = document.getElementById('timer');
            const resendBtn = document.getElementById('resend-btn');
            
            timerElement.style.display = 'inline';
            resendBtn.style.display = 'none';
            
            timerInterval = setInterval(() => {
                timerElement.textContent = `Resend in 0:${seconds.toString().padStart(2, '0')}`;
                seconds--;
                
                if (seconds < 0) {
                    clearInterval(timerInterval);
                    timerElement.style.display = 'none';
                    resendBtn.style.display = 'inline';
                }
            }, 1000);
        }

        async function resendCode() {
            // Show loading state
            const resendBtn = document.getElementById('resend-btn');
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/password-reset/resend-code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear existing code inputs
                    document.querySelectorAll('.code-input').forEach(input => {
                        input.value = '';
                    });
                    document.getElementById('code-1').focus();
                    
                    // Restart timer
                    startTimer();
                } else {
                    alert(data.message || 'Failed to resend code');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend Code';
            }
        }

        // Password visibility toggle
        function togglePasswordVisibility(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Password validation
        document.getElementById('new-password').addEventListener('input', function() {
            const password = this.value;
            
            // Check requirements
            updateRequirement('length-req', password.length >= 8);
            updateRequirement('uppercase-req', /[A-Z]/.test(password));
            updateRequirement('lowercase-req', /[a-z]/.test(password));
            updateRequirement('number-req', /[0-9]/.test(password));
            updateRequirement('special-req', /[!@#$%^&*(),.?":{}|<>]/.test(password));
        });

        function updateRequirement(reqId, isMet) {
            const req = document.getElementById(reqId);
            const icon = req.querySelector('i');
            
            if (isMet) {
                req.classList.add('met');
                icon.classList.remove('fa-circle');
                icon.classList.add('fa-check-circle');
            } else {
                req.classList.remove('met');
                icon.classList.remove('fa-check-circle');
                icon.classList.add('fa-circle');
            }
        }

        // Password match validation
        document.getElementById('confirm-password').addEventListener('input', function() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = this.value;
            const errorText = document.getElementById('password-match-error');
            
            if (confirmPassword && newPassword !== confirmPassword) {
                errorText.style.display = 'block';
            } else {
                errorText.style.display = 'none';
            }
        });

        // Reset password function
        async function resetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!newPassword || !confirmPassword) {
                alert('Please fill in all password fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Check if all requirements are met
            const allRequirementsMet = document.querySelectorAll('.requirement.met').length === 5;
            if (!allRequirementsMet) {
                alert('Please ensure your password meets all requirements');
                return;
            }
            
            // Show loading state
            const resetBtn = document.querySelector('#step3-content .btn-submit');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<span>Resetting...</span><i class="fas fa-spinner fa-spin"></i>';
            resetBtn.disabled = true;
            
            try {
                const response = await fetch('/api/password-reset/reset/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    document.querySelectorAll('.step-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById('success-content').classList.add('active');
                } else {
                    alert(data.message || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            } finally {
                // Restore button state
                resetBtn.innerHTML = originalText;
                resetBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
